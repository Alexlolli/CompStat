---
title: "Assignment 1 <br> Density Estimation"
author: "ADA"
date: "September 18, 2019"
output:
  xaringan::moon_reader:
    css: ["science.css"]
    nature:
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:10'
      navigation:
        scroll: false
---

```{r init, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(cache = TRUE, fig.width = 8, fig.height = 6, comment = NA,
                      dev.args = list(bg = 'transparent'), fig.align = "center")

library(dplyr)
library(ggplot2)
library(microbenchmark)

infrared <- read.table("C:/Users/Alexander Lollike/Documents/Dropbox/GitHub/CompStat/Data/infrared.txt", header = TRUE)

F12<-infrared$F12


```

## Agenda


* Set-up object orienting and binning.

--

* Benchmarking
--

* Bandwidth selection, minimizing AMISE or Cross-validation.
--

* AMISE: Silvermans rule of thumb. 

--

* AMISE: Estimating $||f_0^{''}||_2^2$

--

* K-fold Cross-validation

--

* Results

--

* Benchmarking and profiling.

---

## Problem 1.4

Simulate multimodal data with density $$  f_0(x) = \frac{1}{2 }\left( \frac{1}{\sqrt{2\pi\sigma_1}} e^{\frac{-(x-\mu_1)^2}{2\sigma_1^2}}+ \frac{1}{\sqrt{2\pi\sigma_2}} e^{\frac{-(x-\mu_2)^2}{2\sigma_2^2}} \right) $$

```{r, echo = FALSE}
set.seed(1234)
Nsim <- 2^20
par_1 <- c( 0, 1)
par_2 <- c( 6, 2)
  
```

```{r}
MM_var<-rbinom(Nsim, size = 1,p=0.5) #Bernouilli variables

x <- (1-MM_var)* rnorm(Nsim, mean = par_1[1], sd = par_1[2]) +
        MM_var * rnorm(Nsim, mean = par_2[1], sd = par_2[2])
```


```{r, echo = FALSE}

rg_x <- range(x)
x_vals <- seq(rg_x[1], rg_x[2], length.out = 512)

```

```{r hist_sim_data, fig.asp = 0.55, out.height = 280, dpi=300, echo = FALSE}
hist(x, prob = TRUE, breaks = 60, main = paste("Histogram of x. par_1=c(",par_1[1],",",par_1[2],") and par_2=c(",par_2[1],",",par_2[2],")", sep=""))
lines(x=x_vals,y=0.5*dnorm(x_vals, mean = par_1[1], sd = par_1[2])+0.5*dnorm(x_vals, mean = par_2[1], sd = par_2[2]))
```


---
## Estimating density

Using Niels' vectorized implementation, for given bandwidth.

```{r}
EpDens <- function (x, h, m = 512) {
  rg <- range(x)
  xx <- seq(rg[1] - 3 * h, rg[2] + 3 * h, length.out = m)
  y <- numeric(m) 
  const <- (h * length(x))
  for (i in seq_along(xx))
    y[i] <- sum((1-(x-xx[i])^2/h^2)*(((x-xx[i])/h)<1 & ((x-xx[i])/h)>-1))/const*3/4
  list(x = xx, y = y)
}

```

---
## Bandwidth

To calculate the bandwith that minimizes AMISE, we need to calculate $$\sigma_{K}^4:=\left( \frac{3}{5}\int_{-1}^1 z^2(1-z^2) dz \right)^2 = \frac{1}{25}$$
$$||K||_2^2:=\int_{-1}^1 \left(\frac{3}{4} (1-z^2) \right)^2 dz=\frac{3}{5}$$
and
$$
||f_0^{''}||_2^2=\int (f^{''}_0(z))^2 dz
$$
Which depends on the true density of the data $f_0$. We are cought in a Catch-22 situation!

---
## Estimating $||f_0^{''}||$

Assume the data is Gaussian, then

$$
||f_0^{''}||_2^2=\frac{3}{8 \sigma^5 \sqrt{\pi}}
$$
Which depends on the standard deviation, that can be estimated emperically using the emperical standard deviation $. But Silverman suggests instead to use
$$
\tilde{\sigma}=\min \lbrace \hat{\sigma}, \text{IQR}/1.35 \rbrace
$$

```{r plot1, echo = FALSE}

tilde_sd <- min( sd(log(F12)) , (quantile(log(F12),p=0.75)-quantile(log(F12),p=0.25)) / 1.35)

f_Gauss_est <- 3/(8*tilde_sd^5*sqrt(pi))

K_2 <- 3/5

sigma_k_4 <- 1/25 

h_n<-(K_2/(sigma_k_4*f_Gauss_est))^(1/5)*length(F12)^(-1/5)

hist(log(F12), prob = T)
lines(EpDens(log(F12), h = h_n), lty = 3)

```
---
## How does it look?

```{r, echo = FALSE}
par(mfrow = c(2, 1))
<<plot1>>
```



---
## Problem 1.4

```{r hist1, eval = FALSE}
hist(log(infrared$F12), 20); rug(log(infrared$F12))
hist(log(infrared$F12), 100); rug(log(infrared$F12))
```

```{r, echo = FALSE}
par(mfcol = c(1, 2))
<<hist1>>
```
